<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발표자 모드 - 실시간 동기화 프레젠테이션</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .presentation-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .slide-area {
            flex-grow: 1;
            overflow: auto;
            scroll-snap-type: y mandatory;
            width: 100%;
        }
        .slide-content {
            scroll-snap-align: start;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px; /* 패딩 줄임 */
            box-sizing: border-box;
            width: 100%; 
            max-width: 100%;
            overflow-x: hidden;
        }

        @media (max-width: 768px) {
            .slide-content {
                padding: 5px; /* 모바일에서 패딩 더 줄임 */
            }
        }
        .participants-overlay {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            max-width: 300px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .participant-badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            display: inline-block;
            margin: 2px;
        }
        .participant-presenter {
            background-color: rgba(255, 215, 0, 0.5);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1>발표자 모드</h1>
                <div class="header-info">
                    <span>
                        <i class="fas fa-user"></i>
                        <span id="userName"></span>
                    </span>
                    <span>
                        <i class="fas fa-door-open"></i>
                        <span id="roomId"></span>
                        <button id="copyRoomBtn" class="btn btn-secondary" title="룸 ID 복사">
                            <i class="fas fa-copy"></i>
                        </button>
                    </span>
                    <span>
                        <i class="fas fa-users"></i>
                        <span id="participantCount">0</span>
                    </span>
                    <button id="exitBtn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> 나가기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container presentation-container">
        <div class="slide-area" id="slideArea">
            <!-- 슬라이드들이 여기에 동적으로 추가됩니다 -->
        </div>
        
        <!-- 참가자 목록 오버레이 -->
        <div class="participants-overlay" id="participantsOverlay">
            <!-- 참가자들이 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const slideArea = document.getElementById('slideArea');
    const participantsOverlay = document.getElementById('participantsOverlay');
    const participantCount = document.getElementById('participantCount');
    const userName = document.getElementById('userName');
    const roomIdDisplay = document.getElementById('roomId');
    const exitBtn = document.getElementById('exitBtn');
    
    // 슬라이드 렌더링 함수
    function renderSlides() {
        slideArea.innerHTML = '';
        
        SLIDES.forEach((slide, index) => {
            const slideElement = document.createElement('div');
            slideElement.className = 'slide-content';
            slideElement.dataset.slideIndex = index;
            
            // title이 있을 경우에만 추가
            if (slide.title) {
                const titleElement = document.createElement('h2');
                titleElement.textContent = slide.title;
                slideElement.appendChild(titleElement);
            }
            
            // content가 있을 경우에만 추가
            if (slide.content) {
                const contentElement = document.createElement('div');
                // formatMessage 함수를 사용하지 않고 직접 innerHTML 설정
                // 또는 slide.contentType을 확인하여 HTML 여부 결정
                if (slide.contentType === 'html') {
                    contentElement.innerHTML = slide.content;
                } else {
                    contentElement.innerHTML = formatMessage(slide.content);
                }
                slideElement.appendChild(contentElement);
            }
            
            // 이미지 추가
            if (slide.image) {
                const imageElement = document.createElement('img');
                imageElement.src = slide.image;
                imageElement.alt = slide.title || 'Slide ' + (index + 1);
                imageElement.style.maxWidth = '100%'; // 이미지 크기 조정
                imageElement.style.maxHeight = '300px'; // 최대 높이 설정
                slideElement.appendChild(imageElement);
            }
            
            // 슬라이드에 최소한 하나의 요소가 있을 경우에만 추가
            if (slide.title || slide.content || slide.image) {
                slideArea.appendChild(slideElement);
            } else {
                // 내용이 없는 경우에도 빈 슬라이드 추가 (인덱스 유지를 위해)
                const emptyElement = document.createElement('div');
                emptyElement.className = 'slide-content empty-slide';
                emptyElement.dataset.slideIndex = index;
                emptyElement.innerHTML = '<div class="empty-slide-text">슬라이드 ' + (index + 1) + '</div>';
                slideArea.appendChild(emptyElement);
            }
        });
    }
            
    // 참가자 목록 업데이트 함수
    function updateParticipantList(participants) {
        participantsOverlay.innerHTML = '';
        participantCount.textContent = participants.length;
        
        participants.forEach(participant => {
            const participantEl = document.createElement('span');
            participantEl.className = `participant-badge ${participant.isPresenter ? 'participant-presenter' : ''}`;
            participantEl.textContent = participant.name + (participant.isPresenter ? ' (발표자)' : '');
            
            // 발표자가 아닌 경우, 클릭 이벤트 추가 (발표자 권한 이전)
            if (!participant.isPresenter) {
                participantEl.style.cursor = 'pointer';
                participantEl.title = '발표자로 지정하려면 클릭하세요';
                participantEl.addEventListener('click', function() {
                    if (confirm(`${participant.name}님을 발표자로 지정하시겠습니까?`)) {
                        socket.emit('transferPresenter', participant.id);
                    }
                });
            }
            
            participantsOverlay.appendChild(participantEl);
        });
    }
            
    // 초기 렌더링
    renderSlides();
    
    // 유저 정보 표시
    userName.textContent = USER.name;
    roomIdDisplay.textContent = USER.roomId;
    
    // 룸 ID 복사
    copyRoomBtn.addEventListener('click', function() {
        const roomUrl = `${window.location.origin}?room=${USER.roomId}`;
        navigator.clipboard.writeText(roomUrl)
            .then(() => alert('초대 링크가 클립보드에 복사되었습니다.'))
            .catch(err => console.error('복사 실패:', err));
    });
    
    // 나가기 버튼
    exitBtn.addEventListener('click', function() {
        if (confirm('정말 나가시겠습니까?')) {
            window.location.href = 'index.html';
        }
    });
    
    // 현재 슬라이드 추적 변수
    let currentSlideIndex = 0;
    
    // 스크롤 이벤트 리스너 (발표자의 경우 소켓으로 동기화)
    slideArea.addEventListener('scroll', function() {
        const slides = this.querySelectorAll('.slide-content');
        slides.forEach((slide, index) => {
            const rect = slide.getBoundingClientRect();
            if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                if (currentSlideIndex !== index) {
                    currentSlideIndex = index;
                    // 현재 슬라이드 변경을 서버에 알림
                    socket.emit('changeSlide', { slideNumber: index });
                }
            }
        });
        
        // 현재 슬라이드의 스크롤 위치를 소켓으로 전송
        socket.emit('scrollPresentation', {
            scrollTop: this.scrollTop,
            slideNumber: currentSlideIndex
        });
    });
    
    // Socket.io 초기화
    const socket = initializeSocket({
        onParticipantsUpdate: (data) => {
            updateParticipantList(data.participants);
        },
        onPresenterChanged: (data) => {
            const isNowPresenter = data.newPresenterId === USER.id;
            const wasPresenter = data.previousPresenterId === USER.id;
            
            if (isNowPresenter) {
                alert('당신이 새로운 발표자로 지정되었습니다.');
            } else if (wasPresenter) {
                alert('발표자 권한이 다른 사용자에게 이전되었습니다.');
            }
        }
    });
});
    </script>
</body>
</html>