<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>참가자 모드 - 실시간 동기화 프레젠테이션</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .presentation-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .slide-area {
            flex-grow: 1;
            overflow: auto;
            scroll-snap-type: y mandatory;
            width: 100%;
        }
        .slide-content {
            scroll-snap-align: start;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px; /* 패딩 줄임 */
            box-sizing: border-box;
            width: 100%; 
            max-width: 100%;
            overflow-x: hidden;
        }

        @media (max-width: 768px) {
            .slide-content {
                padding: 5px; /* 모바일에서 패딩 더 줄임 */
            }
        }
        .participants-overlay {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            max-width: 300px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .participant-badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.9em;
            display: inline-block;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1>참가자 모드 - 실시간 동기화 프레젠테이션</h1>
                <div class="header-info">
                    <span>
                        <i class="fas fa-user"></i>
                        <span id="userName"></span>
                    </span>
                    <span>
                        <i class="fas fa-door-open"></i>
                        <span id="roomId"></span>
                    </span>
                    <span>
                        <i class="fas fa-users"></i>
                        <span id="participantCount">0</span>
                    </span>
                    <button id="exitBtn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> 나가기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container presentation-container">
        <div class="slide-area" id="slideArea">
            <!-- 슬라이드들이 여기에 동적으로 추가됩니다 -->
        </div>
        
        <!-- 참가자 목록 오버레이 -->
        <div class="participants-overlay" id="participantsOverlay">
            <!-- 참가자들이 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/common.js"></script>
   <script>
    document.addEventListener('DOMContentLoaded', function() {
    const slideArea = document.getElementById('slideArea');
    const participantsOverlay = document.getElementById('participantsOverlay');
    const participantCount = document.getElementById('participantCount');
    const userName = document.getElementById('userName');
    const roomIdDisplay = document.getElementById('roomId');
    const exitBtn = document.getElementById('exitBtn');
    
    // 슬라이드 렌더링 함수
    function renderSlides() {
        slideArea.innerHTML = '';
        
        SLIDES.forEach((slide, index) => {
            const slideElement = document.createElement('div');
            slideElement.className = 'slide-content';
            slideElement.dataset.slideIndex = index;
            
            // title이 있을 경우에만 추가
            if (slide.title) {
                const titleElement = document.createElement('h2');
                titleElement.textContent = slide.title;
                slideElement.appendChild(titleElement);
            }
            
            // content가 있을 경우에만 추가
            if (slide.content) {
                const contentElement = document.createElement('div');
                // formatMessage 함수를 사용하지 않고 직접 innerHTML 설정
                // 또는 slide.contentType을 확인하여 HTML 여부 결정
                if (slide.contentType === 'html') {
                    contentElement.innerHTML = slide.content;
                } else {
                    contentElement.innerHTML = formatMessage(slide.content);
                }
                slideElement.appendChild(contentElement);
            }
            
            // 이미지 추가
            if (slide.image) {
                const imageElement = document.createElement('img');
                imageElement.src = slide.image;
                imageElement.alt = slide.title || 'Slide ' + (index + 1);
                imageElement.style.maxWidth = '100%'; // 이미지 크기 조정
                imageElement.style.maxHeight = '300px'; // 최대 높이 설정
                slideElement.appendChild(imageElement);
            }
            
            // 슬라이드에 최소한 하나의 요소가 있을 경우에만 추가
            if (slide.title || slide.content || slide.image) {
                slideArea.appendChild(slideElement);
            } else {
                // 내용이 없는 경우에도 빈 슬라이드 추가 (인덱스 유지를 위해)
                const emptyElement = document.createElement('div');
                emptyElement.className = 'slide-content empty-slide';
                emptyElement.dataset.slideIndex = index;
                emptyElement.innerHTML = '<div class="empty-slide-text">슬라이드 ' + (index + 1) + '</div>';
                slideArea.appendChild(emptyElement);
            }
        });
    }
    
    // 참가자 목록 업데이트 함수
    function updateParticipantList(participants) {
        participantsOverlay.innerHTML = '';
        participantCount.textContent = participants.length;
        
        participants.forEach(participant => {
            const participantEl = document.createElement('span');
            participantEl.className = `participant-badge ${participant.isPresenter ? 'participant-presenter' : ''}`;
            participantEl.textContent = participant.name + (participant.isPresenter ? ' (발표자)' : '');
            
            participantsOverlay.appendChild(participantEl);
        });
    }
    
    // 초기 렌더링
    renderSlides();
    
    // 유저 정보 표시
    userName.textContent = USER.name;
    roomIdDisplay.textContent = USER.roomId;
    
    // 나가기 버튼
    exitBtn.addEventListener('click', function() {
        if (confirm('정말 나가시겠습니까?')) {
            localStorage.removeItem('roomId');
            localStorage.removeItem('isPresenter');
            window.location.href = '/';
        }
    });
    
    // 현재 슬라이드 추적 변수
    let currentSlideIndex = 0;
    let isScrollingFromPresenter = false;
    
    // Socket.io 초기화
    const socket = initializeSocket({
        onRoomState: (state) => {
            // 초기 슬라이드 동기화
            const slides = slideArea.querySelectorAll('.slide-content');
            if (slides[state.currentSlide]) {
                isScrollingFromPresenter = true;
                slides[state.currentSlide].scrollIntoView({ behavior: 'smooth' });
                currentSlideIndex = state.currentSlide;
                setTimeout(() => { isScrollingFromPresenter = false; }, 500);
            }
        },
        onSlideChanged: (data) => {
            // 발표자가 슬라이드 변경 시 동기화
            const slides = slideArea.querySelectorAll('.slide-content');
            if (slides[data.slideNumber]) {
                isScrollingFromPresenter = true;
                slides[data.slideNumber].scrollIntoView({ behavior: 'smooth' });
                currentSlideIndex = data.slideNumber;
                setTimeout(() => { isScrollingFromPresenter = false; }, 500);
            }
        },
        onScrollSync: (data) => {
            // 발표자의 스크롤 위치 동기화
            if (currentSlideIndex === data.slideNumber) {
                isScrollingFromPresenter = true;
                slideArea.scrollTop = data.scrollTop;
                setTimeout(() => { isScrollingFromPresenter = false; }, 500);
            }
        },
        onParticipantsUpdate: (data) => {
            updateParticipantList(data.participants);
        },
        onPresenterChanged: (data) => {
            // 내가 발표자가 되었는지 확인
            if (data.newPresenterId === USER.id) {
                alert('당신이 새로운 발표자로 지정되었습니다. 발표자 페이지로 이동합니다.');
                window.location.href = '/presenter.html';
            }
        }
    });
    
    // 참가자의 스크롤은 발표자에 의해서만 움직이도록 제한
    slideArea.addEventListener('scroll', function() {
        // 발표자에 의한 스크롤이 아닌 경우 원래 위치로 복원
        if (!isScrollingFromPresenter) {
            const slides = this.querySelectorAll('.slide-content');
            if (slides[currentSlideIndex]) {
                slides[currentSlideIndex].scrollIntoView({ behavior: 'smooth' });
            }
        }
    });
});
   </script>
</body>
</html>